<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Oasis IMG Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="fixed top-4 left-4 z-50 lg:hidden bg-gray-900 text-white p-3 rounded-md">
            <i class="fas fa-bars text-xl"></i>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 w-64 bg-gray-900 text-white transition-transform duration-300 ease-in-out z-40">
            <div class="p-6">
                <h2 class="text-2xl font-bold">Oasis IMG</h2>
                <p class="text-sm text-gray-400">Admin Dashboard</p>
            </div>
            <nav class="mt-6 overflow-y-auto h-[calc(100vh-120px)]">
                <a href="index.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-home mr-3"></i> Dashboard
                </a>
                <a href="admissions.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-user-graduate mr-3"></i> Admissions
                </a>
                <a href="news.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-newspaper mr-3"></i> News
                </a>
                <a href="courses.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-book mr-3"></i> Programs Offered
                </a>
                <a href="events.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-calendar mr-3"></i> Events
                </a>
                <a href="ministries.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-church mr-3"></i> Ministries
                </a>
                <a href="contacts.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-envelope mr-3"></i> Contacts
                </a>
                <a href="gallery.html" class="flex items-center px-6 py-3 bg-blue-600 text-white">
                    <i class="fas fa-images mr-3"></i> Gallery
                </a>
                <a href="leadership.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-users mr-3"></i> Leadership
                </a>
                <button onclick="handleLogout()" class="w-full flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 mt-auto">
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                </button>
            </nav>
        </aside>

        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden"></div>

        <main class="flex-1 overflow-y-auto lg:ml-0">
            <header class="bg-white shadow-sm p-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Gallery Management</h1>
                    <button onclick="showAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Image
                    </button>
                </div>
            </header>

            <div class="p-6">
                <!-- Search Bar -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <div class="flex items-center">
                        <i class="fas fa-search text-gray-400 mr-3"></i>
                        <input type="text" id="searchInput" placeholder="Search images by title or category..."
                               class="flex-1 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600"
                               oninput="handleSearch()">
                    </div>
                </div>

                <!-- Gallery Grid -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-bold mb-4">Gallery Images</h2>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600">Loading gallery...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="hidden text-center py-12">
                        <i class="fas fa-images text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 mb-4">No images in gallery</p>
                        <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Add First Image
                        </button>
                    </div>

                    <!-- Gallery Grid -->
                    <div id="galleryGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold">Add Image</h2>
                <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="imageForm" class="space-y-4">
                <input type="hidden" id="imageId">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Title <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="imageTitle" required
                           class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600"
                           placeholder="Enter image title">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Category <span class="text-red-500">*</span>
                    </label>
                    <select id="imageCategory" required
                            class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                        <option value="">Select Category</option>
                        <option value="Events">Events</option>
                        <option value="Worship">Worship</option>
                        <option value="Ministry">Ministry</option>
                        <option value="Outreach">Outreach</option>
                        <option value="Facilities">Facilities</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Image URL <span class="text-red-500">*</span>
                    </label>
                    <input type="url" id="imageUrl" required
                           class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600"
                           placeholder="Paste image URL or Google Drive link">
                    <p class="text-sm text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Supports direct image URLs and Google Drive share links
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    <textarea id="imageDescription" rows="3"
                              class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600"
                              placeholder="Enter image description (optional)"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeImageModal()"
                            class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>Save Image
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, db } from '../assets/js/firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            collection,
            addDoc,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            query,
            orderBy,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Global variables
        let galleryData = [];
        let filteredData = [];

        // Logout function
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out: ' + error.message);
            }
        };

        // Auth state check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                loadGallery();
            }
        });

        // Load Gallery from Firestore
        async function loadGallery() {
            try {
                const loadingState = document.getElementById('loadingState');
                const emptyState = document.getElementById('emptyState');
                const galleryGrid = document.getElementById('galleryGrid');

                loadingState.classList.remove('hidden');
                emptyState.classList.add('hidden');
                galleryGrid.classList.add('hidden');

                const q = query(collection(db, 'gallery'), orderBy('uploadDate', 'desc'));
                const querySnapshot = await getDocs(q);

                galleryData = [];
                querySnapshot.forEach((doc) => {
                    galleryData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                filteredData = [...galleryData];
                renderGallery();

                loadingState.classList.add('hidden');

                if (galleryData.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    galleryGrid.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
                showToast('Error loading gallery: ' + error.message, 'error');
                document.getElementById('loadingState').classList.add('hidden');
            }
        }

        // Render Gallery
        function renderGallery() {
            const galleryGrid = document.getElementById('galleryGrid');
            const emptyState = document.getElementById('emptyState');

            if (filteredData.length === 0) {
                galleryGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            galleryGrid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            galleryGrid.innerHTML = '';

            filteredData.forEach(image => {
                const imageUrl = window.convertGoogleDriveUrl ?
                    window.convertGoogleDriveUrl(image.imageUrl) : image.imageUrl;

                const uploadDate = image.uploadDate?.toDate ?
                    image.uploadDate.toDate() : new Date(image.uploadDate);

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition';
                card.innerHTML = `
                    <div class="relative group">
                        <img src="${imageUrl}" alt="${image.title}"
                             class="w-full h-48 object-cover"
                             onerror="this.src='../assets/images/placeholder.jpg'">
                        <div class="absolute top-2 right-2 flex space-x-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="editImage('${image.id}')"
                                    class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 shadow-lg">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteImage('${image.id}')"
                                    class="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 shadow-lg">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">${image.title}</h3>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                ${image.category}
                            </span>
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-calendar mr-1"></i>
                                ${uploadDate.toLocaleDateString()}
                            </span>
                        </div>
                        ${image.description ? `
                            <p class="text-sm text-gray-600 mt-2 line-clamp-2">${image.description}</p>
                        ` : ''}
                    </div>
                `;
                galleryGrid.appendChild(card);
            });
        }

        // Search functionality
        window.handleSearch = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (searchTerm === '') {
                filteredData = [...galleryData];
            } else {
                filteredData = galleryData.filter(image =>
                    image.title.toLowerCase().includes(searchTerm) ||
                    image.category.toLowerCase().includes(searchTerm) ||
                    (image.description && image.description.toLowerCase().includes(searchTerm))
                );
            }

            renderGallery();
        };

        // Show Add Modal
        window.showAddModal = function() {
            document.getElementById('modalTitle').textContent = 'Add Image';
            document.getElementById('imageForm').reset();
            document.getElementById('imageId').value = '';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Image';
            document.getElementById('imageModal').classList.remove('hidden');
        };

        // Show Edit Modal
        window.editImage = async function(id) {
            const image = galleryData.find(img => img.id === id);
            if (!image) return;

            document.getElementById('modalTitle').textContent = 'Edit Image';
            document.getElementById('imageId').value = id;
            document.getElementById('imageTitle').value = image.title;
            document.getElementById('imageCategory').value = image.category;
            document.getElementById('imageUrl').value = image.imageUrl;
            document.getElementById('imageDescription').value = image.description || '';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Update Image';
            document.getElementById('imageModal').classList.remove('hidden');
        };

        // Close Modal
        window.closeImageModal = function() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageForm').reset();
        };

        // Handle Form Submit
        document.getElementById('imageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            submitBtn.disabled = true;

            try {
                const imageId = document.getElementById('imageId').value;
                const imageData = {
                    title: document.getElementById('imageTitle').value,
                    category: document.getElementById('imageCategory').value,
                    imageUrl: document.getElementById('imageUrl').value,
                    description: document.getElementById('imageDescription').value,
                    uploadDate: Timestamp.now()
                };

                if (imageId) {
                    // Update existing image
                    await updateDoc(doc(db, 'gallery', imageId), imageData);
                    showToast('Image updated successfully!', 'success');
                } else {
                    // Add new image
                    await addDoc(collection(db, 'gallery'), imageData);
                    showToast('Image added successfully!', 'success');
                }

                closeImageModal();
                await loadGallery();
            } catch (error) {
                console.error('Error saving image:', error);
                showToast('Error saving image: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Delete Image
        window.deleteImage = async function(id) {
            const image = galleryData.find(img => img.id === id);
            if (!image) return;

            if (!confirm(`Are you sure you want to delete "${image.title}"?`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'gallery', id));
                showToast('Image deleted successfully!', 'success');
                await loadGallery();
            } catch (error) {
                console.error('Error deleting image:', error);
                showToast('Error deleting image: ' + error.message, 'error');
            }
        };

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' :
                           type === 'error' ? 'bg-red-600' : 'bg-blue-600';

            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Load Google Drive URL converter
        const script = document.createElement('script');
        script.src = '../assets/js/main.js';
        script.type = 'module';
        document.head.appendChild(script);

        // Export functions
        window.loadGallery = loadGallery;
    </script>

    <script>
        // Mobile sidebar toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }

        mobileMenuBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
    </script>
</body>
</html>