<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programs Offered - Oasis IMG Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="fixed top-4 left-4 z-50 lg:hidden bg-gray-900 text-white p-3 rounded-md">
            <i class="fas fa-bars text-xl"></i>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 w-64 bg-gray-900 text-white transition-transform duration-300 ease-in-out z-40">
            <div class="p-6">
                <h2 class="text-2xl font-bold">Oasis IMG</h2>
                <p class="text-sm text-gray-400">Admin Dashboard</p>
            </div>
            <nav class="mt-6 overflow-y-auto h-[calc(100vh-120px)]">
                <a href="index.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-home mr-3"></i> Dashboard
                </a>
                <a href="admissions.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-user-graduate mr-3"></i> Admissions
                </a>
                <a href="news.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-newspaper mr-3"></i> News
                </a>
                <a href="courses.html" class="flex items-center px-6 py-3 bg-blue-600 text-white">
                    <i class="fas fa-book mr-3"></i> Programs Offered
                </a>
                <a href="events.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-calendar mr-3"></i> Events
                </a>
                <a href="ministries.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-church mr-3"></i> Ministries
                </a>
                <a href="contacts.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-envelope mr-3"></i> Contacts
                </a>
                <a href="gallery.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-images mr-3"></i> Gallery
                </a>
                <a href="leadership.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-users mr-3"></i> Leadership
                </a>
                <button onclick="handleLogout()" class="w-full flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 mt-auto">
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                </button>
            </nav>
        </aside>

        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden"></div>

        <main class="flex-1 overflow-y-auto lg:ml-0">
            <header class="bg-white shadow-sm p-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Programs Offered Management</h1>
                    <button onclick="showAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Program
                    </button>
                </div>
            </header>

            <div class="p-6">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="text-lg font-bold">Available Programs</h2>
                        <input type="text" id="search-input" placeholder="Search programs..." class="px-4 py-2 border rounded-md w-64">
                    </div>

                    <div id="courses-list" class="divide-y">
                        <div class="p-12 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                            <p>Loading programs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="courseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold">Add Program</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="courseForm" class="space-y-4">
                <input type="hidden" id="course-id">

                <div>
                    <label class="block text-sm font-medium mb-2">Program Title *</label>
                    <input type="text" id="course-title" name="title" required placeholder="e.g., Diploma in Theology" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Program Type *</label>
                        <select id="course-type" name="type" required class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                            <option value="">Select Type</option>
                            <option value="Diploma">Diploma</option>
                            <option value="Certificate">Certificate</option>
                            <option value="Short Course">Short Course</option>
                            <option value="Ministry Training">Ministry Training</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Duration *</label>
                        <input type="text" id="course-duration" name="duration" required placeholder="e.g., 3 years, 6 months" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Description *</label>
                    <textarea id="course-description" name="description" rows="4" required placeholder="Comprehensive description of the program, objectives, and what students will learn..." class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600"></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tuition Fee</label>
                        <input type="text" id="course-fee" name="fee" placeholder="e.g., GHS 5,000 per year" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Credits/Units</label>
                        <input type="text" id="course-credits" name="credits" placeholder="e.g., 120 credits" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Entry Requirements</label>
                    <textarea id="course-requirements" name="requirements" rows="3" placeholder="List admission/entry requirements (e.g., WASSCE, Baptism, etc.)" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Key Subjects/Modules</label>
                    <textarea id="course-subjects" name="subjects" rows="3" placeholder="List main subjects or modules covered (one per line)" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600"></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Start Date</label>
                        <input type="date" id="course-start" name="startDate" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Application Deadline</label>
                        <input type="date" id="course-deadline" name="deadline" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Image URL</label>
                    <input type="url" id="course-image" name="imageUrl" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                </div>

                <div class="flex items-center space-x-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="course-active" name="active" checked class="mr-2">
                        <label for="course-active" class="text-sm font-medium">Active/Published</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="course-enrollment" name="enrollmentOpen" class="mr-2">
                        <label for="course-enrollment" class="text-sm font-medium">Accepting Applications</label>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border rounded-md hover:bg-gray-50">Cancel</button>
                    <button type="submit" id="submit-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>Save Program
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">Program Details</h2>
                <button onclick="closeViewModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="view-content" class="p-6">
                <!-- Program details will be loaded here -->
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button onclick="printProgram()" class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700">
                    <i class="fas fa-print mr-2"></i>Print
                </button>
                <button onclick="closeViewModal()" class="border px-6 py-2 rounded-md hover:bg-gray-50">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from '../assets/js/firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        let allCourses = [];
        let editingId = null;

        // Logout function
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out: ' + error.message);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                await loadCourses();
            }
        });

        // Load all courses
        async function loadCourses() {
            try {
                const q = query(collection(db, 'courses'));
                const snapshot = await getDocs(q);
                allCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort by program and title
                allCourses.sort((a, b) => {
                    const programCompare = (a.program || '').localeCompare(b.program || '');
                    if (programCompare !== 0) return programCompare;
                    return (a.title || '').localeCompare(b.title || '');
                });

                renderCourses();
            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('courses-list').innerHTML = `
                    <div class="p-12 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                        <p>Error loading courses. Please refresh the page.</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Render courses list
        function renderCourses(coursesArray = allCourses) {
            const list = document.getElementById('courses-list');

            if (coursesArray.length === 0) {
                list.innerHTML = `
                    <div class="p-12 text-center text-gray-500">
                        <i class="fas fa-book text-5xl mb-4"></i>
                        <p>No programs yet. Click "Add Program" to create one.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = coursesArray.map(course => {
                const statusClass = course.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                const statusText = course.active ? 'Published' : 'Draft';
                const enrollmentClass = course.enrollmentOpen ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
                const enrollmentText = course.enrollmentOpen ? 'Accepting Applications' : 'Applications Closed';

                return `
                    <div class="p-6 hover:bg-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-900">${course.title}</h3>
                                        ${course.type ? `<p class="text-sm text-gray-500">${course.type}</p>` : ''}
                                    </div>
                                    <div class="flex space-x-2">
                                        <span class="${statusClass} text-xs px-2 py-1 rounded">${statusText}</span>
                                        <span class="${enrollmentClass} text-xs px-2 py-1 rounded">${enrollmentText}</span>
                                    </div>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                    ${course.duration ? `<div><i class="fas fa-clock mr-2 text-blue-600"></i>${course.duration}</div>` : ''}
                                    ${course.credits ? `<div><i class="fas fa-award mr-2 text-blue-600"></i>${course.credits}</div>` : ''}
                                    ${course.fee ? `<div><i class="fas fa-money-bill mr-2 text-blue-600"></i>${course.fee}</div>` : ''}
                                    ${course.startDate ? `<div><i class="fas fa-calendar mr-2 text-blue-600"></i>Starts: ${new Date(course.startDate).toLocaleDateString()}</div>` : ''}
                                </div>
                                <p class="text-gray-600 mb-2">${course.description?.substring(0, 150)}${(course.description?.length || 0) > 150 ? '...' : ''}</p>
                                ${course.deadline ? `
                                    <p class="text-sm text-orange-600">
                                        <i class="fas fa-exclamation-circle mr-1"></i>
                                        Application Deadline: ${new Date(course.deadline).toLocaleDateString()}
                                    </p>
                                ` : ''}
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button onclick="viewCourse('${course.id}')" class="text-green-600 hover:text-green-700 p-2" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editCourse('${course.id}')" class="text-blue-600 hover:text-blue-700 p-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteCourse('${course.id}')" class="text-red-600 hover:text-red-700 p-2" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Search functionality
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allCourses.filter(course =>
                course.title?.toLowerCase().includes(searchTerm) ||
                course.code?.toLowerCase().includes(searchTerm) ||
                course.program?.toLowerCase().includes(searchTerm) ||
                course.instructor?.toLowerCase().includes(searchTerm)
            );
            renderCourses(filtered);
        });

        // Show add modal
        window.showAddModal = function() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Add Program';
            document.getElementById('courseForm').reset();
            document.getElementById('course-id').value = '';
            document.getElementById('course-active').checked = true;
            document.getElementById('courseModal').classList.remove('hidden');
        };

        // Edit course
        window.editCourse = function(id) {
            editingId = id;
            const course = allCourses.find(c => c.id === id);
            if (!course) return;

            document.getElementById('modal-title').textContent = 'Edit Program';
            document.getElementById('course-id').value = id;
            document.getElementById('course-title').value = course.title || '';
            document.getElementById('course-type').value = course.type || '';
            document.getElementById('course-duration').value = course.duration || '';
            document.getElementById('course-description').value = course.description || '';
            document.getElementById('course-fee').value = course.fee || '';
            document.getElementById('course-credits').value = course.credits || '';
            document.getElementById('course-requirements').value = course.requirements || '';
            document.getElementById('course-subjects').value = course.subjects || '';
            document.getElementById('course-start').value = course.startDate || '';
            document.getElementById('course-deadline').value = course.deadline || '';
            document.getElementById('course-image').value = course.imageUrl || '';
            document.getElementById('course-active').checked = course.active !== false;
            document.getElementById('course-enrollment').checked = course.enrollmentOpen === true;
            document.getElementById('courseModal').classList.remove('hidden');
        };

        // View course details
        window.viewCourse = function(id) {
            const course = allCourses.find(c => c.id === id);
            if (!course) return;

            const viewContent = document.getElementById('view-content');
            const subjectsList = course.subjects ? course.subjects.split('\n').filter(s => s.trim()).map(s => `<li class="flex items-start"><i class="fas fa-check-circle text-blue-600 mr-2 mt-1"></i><span>${s.trim()}</span></li>`).join('') : '';

            viewContent.innerHTML = `
                <div class="space-y-6">
                    ${course.imageUrl ? `
                        <div class="mb-6">
                            <img src="${course.imageUrl}" alt="${course.title}" class="w-full h-64 object-cover rounded-lg">
                        </div>
                    ` : ''}

                    <div>
                        <h3 class="text-3xl font-bold text-gray-900 mb-2">${course.title}</h3>
                        ${course.type ? `<p class="text-lg text-blue-600 font-semibold mb-4">${course.type}</p>` : ''}
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        ${course.duration ? `
                            <div class="border-l-4 border-blue-600 pl-4">
                                <p class="text-sm text-gray-500 mb-1">Duration</p>
                                <p class="font-semibold text-gray-900">${course.duration}</p>
                            </div>
                        ` : ''}
                        ${course.credits ? `
                            <div class="border-l-4 border-blue-600 pl-4">
                                <p class="text-sm text-gray-500 mb-1">Credits/Units</p>
                                <p class="font-semibold text-gray-900">${course.credits}</p>
                            </div>
                        ` : ''}
                        ${course.fee ? `
                            <div class="border-l-4 border-blue-600 pl-4">
                                <p class="text-sm text-gray-500 mb-1">Tuition Fee</p>
                                <p class="font-semibold text-gray-900">${course.fee}</p>
                            </div>
                        ` : ''}
                        ${course.startDate ? `
                            <div class="border-l-4 border-blue-600 pl-4">
                                <p class="text-sm text-gray-500 mb-1">Start Date</p>
                                <p class="font-semibold text-gray-900">${new Date(course.startDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </div>
                        ` : ''}
                        ${course.deadline ? `
                            <div class="border-l-4 border-orange-600 pl-4">
                                <p class="text-sm text-gray-500 mb-1">Application Deadline</p>
                                <p class="font-semibold text-orange-600">${new Date(course.deadline).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex space-x-4">
                        <span class="bg-${course.active ? 'green' : 'gray'}-100 text-${course.active ? 'green' : 'gray'}-800 px-4 py-2 rounded-full text-sm font-semibold">
                            ${course.active ? 'Published' : 'Draft'}
                        </span>
                        <span class="bg-${course.enrollmentOpen ? 'blue' : 'gray'}-100 text-${course.enrollmentOpen ? 'blue' : 'gray'}-800 px-4 py-2 rounded-full text-sm font-semibold">
                            ${course.enrollmentOpen ? 'Accepting Applications' : 'Applications Closed'}
                        </span>
                    </div>

                    ${course.description ? `
                        <div class="border-t pt-6">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Description</h4>
                            <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${course.description}</p>
                        </div>
                    ` : ''}

                    ${course.requirements ? `
                        <div class="border-t pt-6">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Entry Requirements</h4>
                            <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${course.requirements}</p>
                        </div>
                    ` : ''}

                    ${course.subjects ? `
                        <div class="border-t pt-6">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Key Subjects/Modules</h4>
                            <ul class="space-y-2 text-gray-700">
                                ${subjectsList}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="border-t pt-6 text-sm text-gray-500">
                        <p>Created: ${course.createdAt ? new Date(course.createdAt).toLocaleString() : 'N/A'}</p>
                        <p>Last Updated: ${course.updatedAt ? new Date(course.updatedAt).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
            `;

            document.getElementById('viewModal').classList.remove('hidden');
        };

        // Close view modal
        window.closeViewModal = function() {
            document.getElementById('viewModal').classList.add('hidden');
        };

        // Print program
        window.printProgram = function() {
            window.print();
        };

        // Delete course
        window.deleteCourse = async function(id) {
            if (!confirm('Are you sure you want to delete this program?')) return;

            try {
                await deleteDoc(doc(db, 'courses', id));
                alert('Program deleted successfully!');
                await loadCourses();
            } catch (error) {
                console.error('Error deleting program:', error);
                alert('Error deleting program: ' + error.message);
            }
        };

        // Close modal
        window.closeModal = function() {
            document.getElementById('courseModal').classList.add('hidden');
            document.getElementById('courseForm').reset();
            editingId = null;
        };

        // Form submit
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            const formData = new FormData(e.target);
            const data = {
                title: formData.get('title'),
                type: formData.get('type'),
                duration: formData.get('duration'),
                description: formData.get('description'),
                fee: formData.get('fee') || '',
                credits: formData.get('credits') || '',
                requirements: formData.get('requirements') || '',
                subjects: formData.get('subjects') || '',
                startDate: formData.get('startDate') || '',
                deadline: formData.get('deadline') || '',
                imageUrl: formData.get('imageUrl') || '',
                active: document.getElementById('course-active').checked,
                enrollmentOpen: document.getElementById('course-enrollment').checked,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingId) {
                    await updateDoc(doc(db, 'courses', editingId), data);
                    alert('Program updated successfully!');
                } else {
                    data.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'courses'), data);
                    alert('Program added successfully!');
                }

                closeModal();
                await loadCourses();
            } catch (error) {
                console.error('Error saving program:', error);
                alert('Error saving program: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    </script>

    <script>
        // Mobile sidebar toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }

        mobileMenuBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
    </script>
</body>
</html>
