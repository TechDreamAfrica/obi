<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBI Admissions - Oasis IMG Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            * {
                overflow: visible !important;
            }
            .no-print { display: none !important; }
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            html, body {
                height: auto !important;
                overflow: visible !important;
            }
            .print-only { display: block !important; }
            #viewModal {
                position: static !important;
                display: block !important;
                background: white !important;
                max-width: 100% !important;
                max-height: none !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important;
                margin: 0 !important;
                inset: auto !important;
                transform: none !important;
            }
            #viewModal > div {
                max-width: 100% !important;
                max-height: none !important;
                height: auto !important;
                overflow: visible !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                transform: none !important;
            }
            #viewModal .sticky {
                position: static !important;
            }
            #modal-content {
                overflow: visible !important;
                max-height: none !important;
                height: auto !important;
            }
            .grid {
                page-break-inside: avoid;
            }
            .space-y-4 {
                page-break-inside: avoid;
            }
        }
        .print-only { display: none; }
        .status-badge-pending { background-color: #fef3c7; color: #92400e; }
        .status-badge-approved { background-color: #d1fae5; color: #065f46; }
        .status-badge-rejected { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-700">Loading applications...</p>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="fixed top-4 left-4 z-50 lg:hidden bg-gray-900 text-white p-3 rounded-md no-print">
            <i class="fas fa-bars text-xl"></i>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 w-64 bg-gray-900 text-white transition-transform duration-300 ease-in-out z-40 no-print">
            <div class="p-6">
                <h2 class="text-2xl font-bold">Oasis IMG</h2>
                <p class="text-sm text-gray-400">Admin Dashboard</p>
            </div>
            <nav class="mt-6 overflow-y-auto h-[calc(100vh-120px)]">
                <a href="index.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-home mr-3"></i> Dashboard
                </a>
                <a href="admissions.html" class="flex items-center px-6 py-3 bg-blue-600 text-white">
                    <i class="fas fa-user-graduate mr-3"></i> Admissions
                </a>
                <a href="news.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-newspaper mr-3"></i> News
                </a>
                <a href="courses.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-book mr-3"></i> Programs Offered
                </a>
                <a href="events.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-calendar mr-3"></i> Events
                </a>
                <a href="ministries.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-church mr-3"></i> Ministries
                </a>
                <a href="contacts.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-envelope mr-3"></i> Contacts
                </a>
                <a href="gallery.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-images mr-3"></i> Gallery
                </a>
                <a href="leadership.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-users mr-3"></i> Leadership
                </a>
            </nav>
        </aside>

        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden no-print"></div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto lg:ml-0">
            <!-- Header -->
            <header class="bg-white shadow-sm p-6 no-print lg:pl-6 pl-20">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">OBI Application Management</h1>
                        <p class="text-gray-600 mt-1">Manage and review Bible Institute applications</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
                            <i class="fas fa-file-excel mr-2"></i>Export CSV
                        </button>
                        <button onclick="window.print()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
                            <i class="fas fa-print mr-2"></i>Print
                        </button>
                    </div>
                </div>
            </header>

            <!-- Statistics -->
            <div class="p-6 no-print">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Total Applications</p>
                                <p id="stat-total" class="text-3xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="bg-blue-100 rounded-full p-3">
                                <i class="fas fa-file-alt text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Pending</p>
                                <p id="stat-pending" class="text-3xl font-bold text-yellow-600">0</p>
                            </div>
                            <div class="bg-yellow-100 rounded-full p-3">
                                <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Approved</p>
                                <p id="stat-approved" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-green-100 rounded-full p-3">
                                <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Rejected</p>
                                <p id="stat-rejected" class="text-3xl font-bold text-red-600">0</p>
                            </div>
                            <div class="bg-red-100 rounded-full p-3">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="p-4 border-b flex justify-between items-center flex-wrap gap-4">
                        <div class="flex space-x-2">
                            <button onclick="filterByStatus('all')" id="filter-all" class="px-4 py-2 bg-blue-600 text-white rounded-md transition">
                                All (<span id="count-all">0</span>)
                            </button>
                            <button onclick="filterByStatus('pending')" id="filter-pending" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition">
                                Pending (<span id="count-pending">0</span>)
                            </button>
                            <button onclick="filterByStatus('approved')" id="filter-approved" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition">
                                Approved (<span id="count-approved">0</span>)
                            </button>
                            <button onclick="filterByStatus('rejected')" id="filter-rejected" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition">
                                Rejected (<span id="count-rejected">0</span>)
                            </button>
                        </div>
                        <input type="text" id="search-input" placeholder="Search by name, email..." class="px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600 focus:outline-none">
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applicant</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Church</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="applications-table" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="p-4 border-t flex justify-between items-center no-print">
                        <p id="pagination-info" class="text-sm text-gray-600">Showing 0 to 0 of 0 entries</p>
                        <div id="pagination-controls" class="flex space-x-2">
                            <!-- Dynamic pagination buttons -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 print:bg-transparent print:block print:static print:p-0">
        <div id="modal-inner" class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto print:max-w-full print:max-h-none print:overflow-visible print:rounded-none">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center no-print">
                <h2 class="text-2xl font-bold text-gray-900">Application Details</h2>
                <div class="flex space-x-2">
                    <button onclick="printApplication()" class="text-blue-600 hover:bg-blue-50 px-3 py-2 rounded-md transition">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button onclick="closeModal()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="print-only p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">OBI Application Details</h2>
                <p class="text-sm text-gray-500">Oasis Bible Institute</p>
            </div>
            <div id="modal-content" class="p-6 print:overflow-visible">
                <!-- Dynamic content -->
            </div>
            <div class="sticky bottom-0 bg-gray-50 border-t p-6 flex justify-between items-center no-print">
                <div class="flex space-x-3">
                    <button onclick="updateApplicationStatus('approved')" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition">
                        <i class="fas fa-check mr-2"></i>Approve
                    </button>
                    <button onclick="updateApplicationStatus('rejected')" class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700 transition">
                        <i class="fas fa-times mr-2"></i>Reject
                    </button>
                    <button onclick="updateApplicationStatus('pending')" class="bg-yellow-600 text-white px-6 py-2 rounded-md hover:bg-yellow-700 transition">
                        <i class="fas fa-clock mr-2"></i>Set Pending
                    </button>
                </div>
                <button onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../assets/js/firebase-config.js';
        import { collection, getDocs, doc, updateDoc, query, orderBy, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        let allApplications = [];
        let filteredApplications = [];
        let currentFilter = 'all';
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentViewingApp = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            await loadApplications();
            setupSearchListener();
        });

        async function loadApplications() {
            try {
                showLoading();
                console.log('Loading applications from obi-applications...');

                const q = query(collection(db, 'obi-applications'), orderBy('submittedAt', 'desc'));
                const snapshot = await getDocs(q);

                allApplications = [];
                snapshot.forEach(docSnap => {
                    allApplications.push({
                        id: docSnap.id,
                        ...docSnap.data()
                    });
                });

                console.log(`Loaded ${allApplications.length} applications`);
                updateStatistics();
                filterByStatus('all');
                hideLoading();

            } catch (error) {
                console.error('Error loading applications:', error);
                hideLoading();
                showError('Failed to load applications: ' + error.message);
            }
        }

        function updateStatistics() {
            const total = allApplications.length;
            const pending = allApplications.filter(app => app.status === 'pending').length;
            const approved = allApplications.filter(app => app.status === 'approved').length;
            const rejected = allApplications.filter(app => app.status === 'rejected').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-approved').textContent = approved;
            document.getElementById('stat-rejected').textContent = rejected;

            document.getElementById('count-all').textContent = total;
            document.getElementById('count-pending').textContent = pending;
            document.getElementById('count-approved').textContent = approved;
            document.getElementById('count-rejected').textContent = rejected;
        }

        window.filterByStatus = function(status) {
            currentFilter = status;
            currentPage = 1;

            // Update button styles
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition';
            });
            document.getElementById(`filter-${status}`).className = 'px-4 py-2 bg-blue-600 text-white rounded-md transition';

            // Filter applications
            if (status === 'all') {
                filteredApplications = [...allApplications];
            } else {
                filteredApplications = allApplications.filter(app => app.status === status);
            }

            renderTable();
        };

        function renderTable() {
            const tbody = document.getElementById('applications-table');
            tbody.innerHTML = '';

            if (filteredApplications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No applications found</td></tr>';
                return;
            }

            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredApplications.length);
            const pageItems = filteredApplications.slice(startIndex, endIndex);

            pageItems.forEach(app => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition';

                const statusClass = app.status === 'approved' ? 'status-badge-approved' :
                                  app.status === 'rejected' ? 'status-badge-rejected' :
                                  'status-badge-pending';

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <img class="h-10 w-10 rounded-full" src="https://ui-avatars.com/api/?name=${encodeURIComponent(app.name || 'User')}&background=random" alt="">
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${app.name || 'N/A'}</div>
                                <div class="text-sm text-gray-500">${app.sex || 'N/A'}, Age ${app.age || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${app.email || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${app.phone || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${app.churchAttending || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${app.submittedAt ? new Date(app.submittedAt).toLocaleDateString() : 'N/A'}</div>
                        <div class="text-sm text-gray-500">${app.submittedAt ? new Date(app.submittedAt).toLocaleTimeString() : ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${(app.status || 'pending').toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium no-print">
                        <button onclick="viewApplication('${app.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="quickApprove('${app.id}')" class="text-green-600 hover:text-green-900 mr-3" title="Quick Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="quickReject('${app.id}')" class="text-red-600 hover:text-red-900" title="Quick Reject">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredApplications.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredApplications.length);

            document.getElementById('pagination-info').textContent =
                `Showing ${startIndex} to ${endIndex} of ${filteredApplications.length} entries`;

            const controls = document.getElementById('pagination-controls');
            controls.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.className = `px-3 py-1 border rounded-md ${currentPage === 1 ? 'text-gray-400 cursor-not-allowed' : 'hover:bg-gray-50'}`;
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); } };
            controls.appendChild(prevBtn);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `px-3 py-1 border rounded-md ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-50'}`;
                    pageBtn.onclick = () => { currentPage = i; renderTable(); };
                    controls.appendChild(pageBtn);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.className = 'px-2';
                    controls.appendChild(dots);
                }
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.className = `px-3 py-1 border rounded-md ${currentPage === totalPages ? 'text-gray-400 cursor-not-allowed' : 'hover:bg-gray-50'}`;
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; renderTable(); } };
            controls.appendChild(nextBtn);
        }

        window.viewApplication = function(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;

            currentViewingApp = app;
            const modal = document.getElementById('viewModal');
            const content = document.getElementById('modal-content');

            const statusClass = app.status === 'approved' ? 'status-badge-approved' :
                              app.status === 'rejected' ? 'status-badge-rejected' :
                              'status-badge-pending';

            content.innerHTML = `
                <div class="mb-6 pb-4 border-b">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-500">Application ID: ${app.id}</p>
                            <p class="text-sm text-gray-500">Submitted: ${app.submittedAt ? new Date(app.submittedAt).toLocaleString() : 'N/A'}</p>
                        </div>
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${(app.status || 'pending').toUpperCase()}
                        </span>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-2">Personal Information</h3>
                        <div><span class="font-medium text-gray-600">Name:</span> ${app.name || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Email:</span> ${app.email || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Phone:</span> ${app.phone || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Address:</span> ${app.address || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Date of Birth:</span> ${app.dob || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Age:</span> ${app.age || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Sex:</span> ${app.sex || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Marital Status:</span> ${app.maritalStatus || 'N/A'}</div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-2">Spiritual Background</h3>
                        <div><span class="font-medium text-gray-600">Church Attending:</span> ${app.churchAttending || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Saved:</span> ${app.saved || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Water Baptized:</span> ${app.baptized || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Holy Spirit:</span> ${app.holySpirit || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Called to Ministry:</span> ${Array.isArray(app.ministry) ? app.ministry.join(', ') : (app.ministry || 'N/A')}</div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-2">Education & Work</h3>
                        <div><span class="font-medium text-gray-600">Education Level:</span> ${app.educationLevel || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">School:</span> ${app.school || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Degrees:</span> ${app.degrees || 'N/A'}</div>
                        <div><span class="font-medium text-gray-600">Work Experience:</span> ${app.workExperience || 'N/A'}</div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-2">References</h3>
                        <div><span class="font-medium text-gray-600">Pastor 1:</span> ${app.pastor1 || 'N/A'} (${app.pastor1Phone || 'N/A'})</div>
                        <div><span class="font-medium text-gray-600">Pastor 2:</span> ${app.pastor2 || 'N/A'} (${app.pastor2Phone || 'N/A'})</div>
                        <div><span class="font-medium text-gray-600">Referred By:</span> ${app.referredBy || 'N/A'}</div>
                    </div>
                </div>

                ${app.aboutYourself ? `
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-2 mb-4">About</h3>
                        <p class="text-gray-700">${app.aboutYourself}</p>
                    </div>
                ` : ''}
            `;

            modal.classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('viewModal').classList.add('hidden');
            currentViewingApp = null;
        };

        window.updateApplicationStatus = async function(newStatus) {
            if (!currentViewingApp) return;

            if (!confirm(`Are you sure you want to ${newStatus} this application?`)) return;

            try {
                showLoading();
                const appRef = doc(db, 'obi-applications', currentViewingApp.id);
                await updateDoc(appRef, {
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });

                // Update local data
                const app = allApplications.find(a => a.id === currentViewingApp.id);
                if (app) app.status = newStatus;

                updateStatistics();
                renderTable();
                closeModal();
                hideLoading();
                showSuccess(`Application ${newStatus} successfully!`);

            } catch (error) {
                console.error('Error updating status:', error);
                hideLoading();
                showError('Failed to update status: ' + error.message);
            }
        };

        window.quickApprove = async function(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;

            currentViewingApp = app;
            await updateApplicationStatus('approved');
        };

        window.quickReject = async function(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;

            currentViewingApp = app;
            await updateApplicationStatus('rejected');
        };

        window.refreshData = async function() {
            await loadApplications();
        };

        window.exportToCSV = function() {
            const headers = ['Name', 'Email', 'Phone', 'Age', 'Sex', 'Church', 'Status', 'Submitted'];
            const rows = filteredApplications.map(app => [
                app.name || '',
                app.email || '',
                app.phone || '',
                app.age || '',
                app.sex || '',
                app.churchAttending || '',
                app.status || 'pending',
                app.submittedAt ? new Date(app.submittedAt).toLocaleString() : ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `obi-applications-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.printApplication = function() {
            if (!currentViewingApp) {
                alert('No application selected for printing');
                return;
            }

            // Show the modal if it's hidden (ensures content is rendered)
            const modal = document.getElementById('viewModal');
            const modalInner = document.getElementById('modal-inner');
            const wasHidden = modal.classList.contains('hidden');

            if (wasHidden) {
                modal.classList.remove('hidden');
            }

            // Force remove scroll constraints for print
            const originalMaxHeight = modalInner.style.maxHeight;
            const originalOverflow = modalInner.style.overflow;

            // Store original styles
            modalInner.style.maxHeight = 'none';
            modalInner.style.overflow = 'visible';
            modalInner.style.height = 'auto';

            // Give the browser a moment to render the modal content
            setTimeout(() => {
                window.print();

                // Restore original styles after print
                setTimeout(() => {
                    modalInner.style.maxHeight = originalMaxHeight;
                    modalInner.style.overflow = originalOverflow;
                    modalInner.style.height = '';

                    // Hide modal again if it was hidden before
                    if (wasHidden) {
                        modal.classList.add('hidden');
                    }
                }, 100);
            }, 100);
        };

        function setupSearchListener() {
            document.getElementById('search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();

                if (currentFilter === 'all') {
                    filteredApplications = allApplications.filter(app =>
                        (app.name?.toLowerCase().includes(searchTerm)) ||
                        (app.email?.toLowerCase().includes(searchTerm)) ||
                        (app.phone?.toLowerCase().includes(searchTerm))
                    );
                } else {
                    filteredApplications = allApplications
                        .filter(app => app.status === currentFilter)
                        .filter(app =>
                            (app.name?.toLowerCase().includes(searchTerm)) ||
                            (app.email?.toLowerCase().includes(searchTerm)) ||
                            (app.phone?.toLowerCase().includes(searchTerm))
                        );
                }

                currentPage = 1;
                renderTable();
            });
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }
    </script>

    <script>
        // Mobile sidebar toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }

        mobileMenuBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
    </script>
</body>
</html>
