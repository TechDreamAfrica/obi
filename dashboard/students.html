<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Records - Oasis IMG Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .status-badge-active { background-color: #d1fae5; color: #065f46; }
        .status-badge-inactive { background-color: #fee2e2; color: #991b1b; }
        .status-badge-graduated { background-color: #dbeafe; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-700">Loading students...</p>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="fixed top-4 left-4 z-50 lg:hidden bg-gray-900 text-white p-3 rounded-md">
            <i class="fas fa-bars text-xl"></i>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 w-64 bg-gray-900 text-white transition-transform duration-300 ease-in-out z-40">
            <div class="p-6">
                <h2 class="text-2xl font-bold">Oasis IMG</h2>
                <p class="text-sm text-gray-400">Admin Dashboard</p>
            </div>
            <nav class="mt-6 overflow-y-auto h-[calc(100vh-120px)]">
                <a href="index.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-home mr-3"></i> Dashboard
                </a>
                <a href="admissions.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-user-graduate mr-3"></i> Admissions
                </a>
                <a href="students.html" class="flex items-center px-6 py-3 bg-blue-600 text-white">
                    <i class="fas fa-users mr-3"></i> Student Records
                </a>
                <a href="news.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-newspaper mr-3"></i> News
                </a>
                <a href="courses.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-book mr-3"></i> Programs Offered
                </a>
                <a href="events.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-calendar mr-3"></i> Events
                </a>
                <a href="ministries.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-church mr-3"></i> Ministries
                </a>
                <a href="contacts.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-envelope mr-3"></i> Contacts
                </a>
                <a href="gallery.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-images mr-3"></i> Gallery
                </a>
                <a href="leadership.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-users mr-3"></i> Leadership
                </a>
                <a href="site-images.html" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800">
                    <i class="fas fa-photo-video mr-3"></i> Site Images
                </a>
                <button onclick="handleLogout()" class="w-full flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 mt-auto">
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                </button>
            </nav>
        </aside>

        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden"></div>

        <main class="flex-1 overflow-y-auto lg:ml-0">
            <header class="bg-white shadow-sm p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Student Records</h1>
                        <p class="text-sm text-gray-600 mt-1">Manage enrolled students and their information</p>
                    </div>
                    <button onclick="openAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-plus mr-2"></i> Add Student
                    </button>
                </div>
            </header>

            <div class="p-6">
                <!-- Stats Cards -->
                <div class="grid md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Students</p>
                                <p id="total-students" class="text-3xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-users text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Active Students</p>
                                <p id="active-students" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-user-check text-green-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Graduated</p>
                                <p id="graduated-students" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-graduation-cap text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Inactive</p>
                                <p id="inactive-students" class="text-3xl font-bold text-red-600">0</p>
                            </div>
                            <div class="bg-red-100 p-3 rounded-full">
                                <i class="fas fa-user-times text-red-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-900">All Students</h2>
                            <button onclick="exportStudentsToCSV()" class="text-blue-600 hover:text-blue-700 font-semibold">
                                <i class="fas fa-download mr-2"></i>Export CSV
                            </button>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="filterByStatus('all')" id="filter-all" class="px-4 py-2 bg-blue-600 text-white rounded-md transition">
                                    All (<span id="count-all">0</span>)
                                </button>
                                <button onclick="filterByStatus('active')" id="filter-active" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition">
                                    Active (<span id="count-active">0</span>)
                                </button>
                                <button onclick="filterByStatus('graduated')" id="filter-graduated" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition">
                                    Graduated (<span id="count-graduated">0</span>)
                                </button>
                                <button onclick="filterByStatus('inactive')" id="filter-inactive" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition">
                                    Inactive (<span id="count-inactive">0</span>)
                                </button>
                            </div>
                            <input type="text" id="search-input" placeholder="Search by name, ID, program..." class="flex-1 px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600 focus:outline-none">
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enrollment Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="p-4 border-t flex justify-between items-center">
                        <p id="pagination-info" class="text-sm text-gray-600">Showing 0 to 0 of 0 entries</p>
                        <div id="pagination-controls" class="flex space-x-2">
                            <!-- Dynamic pagination buttons -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Student Modal -->
    <div id="studentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900">Add Student</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="studentForm" class="p-6">
                <input type="hidden" id="student-id">
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="fullName" required class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Student ID *</label>
                        <input type="text" id="studentId" required class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" required class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                        <input type="date" id="dob" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                        <select id="gender" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Program *</label>
                        <input type="text" id="program" required class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enrollment Date *</label>
                        <input type="date" id="enrollmentDate" required class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                        <select id="status" required class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="graduated">Graduated</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Church Affiliation</label>
                        <input type="text" id="church" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <textarea id="address" rows="2" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600"></textarea>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="notes" rows="3" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-600" placeholder="Any additional information about the student..."></textarea>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                        <i class="fas fa-save mr-2"></i>Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Student Modal -->
    <div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Student Details</h2>
                <button onclick="closeViewModal()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="view-content" class="p-6">
                <!-- Dynamic content -->
            </div>
            <div class="sticky bottom-0 bg-gray-50 border-t p-6 flex justify-end">
                <button onclick="closeViewModal()" class="px-6 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from '../assets/js/firebase-config.js';
        import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        let allStudents = [];
        let filteredStudents = [];
        let currentFilter = 'all';
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentEditingId = null;

        // Logout function
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out: ' + error.message);
            }
        };

        // Auth check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                loadStudents();
            }
        });

        // Load students with real-time updates
        function loadStudents() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            const q = query(collection(db, 'students'), orderBy('enrollmentDate', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                allStudents = [];
                snapshot.forEach(doc => {
                    allStudents.push({ id: doc.id, ...doc.data() });
                });
                
                updateStats();
                filterByStatus(currentFilter);
                document.getElementById('loading-overlay').classList.add('hidden');
            }, (error) => {
                console.error('Error loading students:', error);
                document.getElementById('loading-overlay').classList.add('hidden');
                alert('Error loading students: ' + error.message);
            });
        }

        // Update statistics
        function updateStats() {
            const total = allStudents.length;
            const active = allStudents.filter(s => s.status === 'active').length;
            const graduated = allStudents.filter(s => s.status === 'graduated').length;
            const inactive = allStudents.filter(s => s.status === 'inactive').length;

            document.getElementById('total-students').textContent = total;
            document.getElementById('active-students').textContent = active;
            document.getElementById('graduated-students').textContent = graduated;
            document.getElementById('inactive-students').textContent = inactive;

            document.getElementById('count-all').textContent = total;
            document.getElementById('count-active').textContent = active;
            document.getElementById('count-graduated').textContent = graduated;
            document.getElementById('count-inactive').textContent = inactive;
        }

        // Filter by status
        window.filterByStatus = function(status) {
            currentFilter = status;
            currentPage = 1;

            // Update button styles
            ['all', 'active', 'graduated', 'inactive'].forEach(s => {
                const btn = document.getElementById(`filter-${s}`);
                if (s === status) {
                    btn.className = 'px-4 py-2 bg-blue-600 text-white rounded-md transition';
                } else {
                    btn.className = 'px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition';
                }
            });

            if (status === 'all') {
                filteredStudents = [...allStudents];
            } else {
                filteredStudents = allStudents.filter(s => s.status === status);
            }

            renderStudents();
        };

        // Search functionality
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm) {
                const baseList = currentFilter === 'all' ? allStudents : allStudents.filter(s => s.status === currentFilter);
                filteredStudents = baseList.filter(s => 
                    s.fullName?.toLowerCase().includes(searchTerm) ||
                    s.studentId?.toLowerCase().includes(searchTerm) ||
                    s.email?.toLowerCase().includes(searchTerm) ||
                    s.program?.toLowerCase().includes(searchTerm)
                );
            } else {
                filterByStatus(currentFilter);
            }
            currentPage = 1;
            renderStudents();
        });

        // Render students table
        function renderStudents() {
            const tbody = document.getElementById('students-table');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedStudents = filteredStudents.slice(start, end);

            if (paginatedStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No students found</td></tr>';
                document.getElementById('pagination-info').textContent = 'Showing 0 to 0 of 0 entries';
                document.getElementById('pagination-controls').innerHTML = '';
                return;
            }

            paginatedStudents.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const statusClass = {
                    active: 'status-badge-active',
                    inactive: 'status-badge-inactive',
                    graduated: 'status-badge-graduated'
                }[student.status] || 'bg-gray-100 text-gray-800';

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(student.fullName)}" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <p class="font-semibold">${student.fullName}</p>
                                <p class="text-sm text-gray-500">${student.email}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">${student.studentId}</td>
                    <td class="px-6 py-4">${student.program}</td>
                    <td class="px-6 py-4">${new Date(student.enrollmentDate).toLocaleDateString()}</td>
                    <td class="px-6 py-4">
                        <span class="${statusClass} text-xs px-3 py-1 rounded-full capitalize">${student.status}</span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="viewStudent('${student.id}')" class="text-blue-600 hover:text-blue-700 mr-3" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="editStudent('${student.id}')" class="text-green-600 hover:text-green-700 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-700" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update pagination info
            const showing = paginatedStudents.length > 0 ? start + 1 : 0;
            const showingEnd = Math.min(end, filteredStudents.length);
            document.getElementById('pagination-info').textContent = 
                `Showing ${showing} to ${showingEnd} of ${filteredStudents.length} entries`;

            // Render pagination controls
            renderPagination();
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
            const controls = document.getElementById('pagination-controls');
            controls.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.className = `px-3 py-1 border rounded-md ${currentPage === 1 ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'}`;
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderStudents();
                }
            };
            controls.appendChild(prevBtn);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = i === currentPage 
                        ? 'px-3 py-1 bg-blue-600 text-white rounded-md' 
                        : 'px-3 py-1 border rounded-md hover:bg-gray-100';
                    pageBtn.onclick = () => {
                        currentPage = i;
                        renderStudents();
                    };
                    controls.appendChild(pageBtn);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.className = 'px-2 text-gray-500';
                    controls.appendChild(dots);
                }
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.className = `px-3 py-1 border rounded-md ${currentPage === totalPages ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'}`;
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderStudents();
                }
            };
            controls.appendChild(nextBtn);
        }

        // Open add modal
        window.openAddModal = function() {
            currentEditingId = null;
            document.getElementById('modal-title').textContent = 'Add Student';
            document.getElementById('studentForm').reset();
            document.getElementById('student-id').value = '';
            document.getElementById('enrollmentDate').valueAsDate = new Date();
            document.getElementById('studentModal').classList.remove('hidden');
        };

        // Edit student
        window.editStudent = function(id) {
            const student = allStudents.find(s => s.id === id);
            if (!student) return;

            currentEditingId = id;
            document.getElementById('modal-title').textContent = 'Edit Student';
            document.getElementById('student-id').value = id;
            document.getElementById('fullName').value = student.fullName || '';
            document.getElementById('studentId').value = student.studentId || '';
            document.getElementById('email').value = student.email || '';
            document.getElementById('phone').value = student.phone || '';
            document.getElementById('dob').value = student.dob || '';
            document.getElementById('gender').value = student.gender || '';
            document.getElementById('program').value = student.program || '';
            document.getElementById('enrollmentDate').value = student.enrollmentDate || '';
            document.getElementById('status').value = student.status || 'active';
            document.getElementById('church').value = student.church || '';
            document.getElementById('address').value = student.address || '';
            document.getElementById('notes').value = student.notes || '';
            
            document.getElementById('studentModal').classList.remove('hidden');
        };

        // View student
        window.viewStudent = function(id) {
            const student = allStudents.find(s => s.id === id);
            if (!student) return;

            const statusClass = {
                active: 'bg-green-100 text-green-800',
                inactive: 'bg-red-100 text-red-800',
                graduated: 'bg-blue-100 text-blue-800'
            }[student.status] || 'bg-gray-100 text-gray-800';

            const content = document.getElementById('view-content');
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center space-x-4">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(student.fullName)}&size=128" class="w-24 h-24 rounded-full">
                            <div>
                                <h3 class="text-2xl font-bold">${student.fullName}</h3>
                                <p class="text-gray-600">${student.studentId}</p>
                                <span class="${statusClass} text-xs px-3 py-1 rounded-full capitalize mt-2 inline-block">${student.status}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Contact Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                <p><span class="font-medium">Email:</span> ${student.email}</p>
                                <p><span class="font-medium">Phone:</span> ${student.phone || 'N/A'}</p>
                                <p><span class="font-medium">Address:</span> ${student.address || 'N/A'}</p>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Personal Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                <p><span class="font-medium">Date of Birth:</span> ${student.dob ? new Date(student.dob).toLocaleDateString() : 'N/A'}</p>
                                <p><span class="font-medium">Gender:</span> ${student.gender || 'N/A'}</p>
                                <p><span class="font-medium">Church:</span> ${student.church || 'N/A'}</p>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Academic Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                <p><span class="font-medium">Program:</span> ${student.program}</p>
                                <p><span class="font-medium">Enrollment Date:</span> ${new Date(student.enrollmentDate).toLocaleDateString()}</p>
                                <p><span class="font-medium">Status:</span> <span class="capitalize">${student.status}</span></p>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Additional Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p>${student.notes || 'No additional notes'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('viewModal').classList.remove('hidden');
        };

        // Delete student
        window.deleteStudent = async function(id) {
            if (!confirm('Are you sure you want to delete this student record? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'students', id));
                alert('Student deleted successfully');
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student: ' + error.message);
            }
        };

        // Handle form submission
        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const studentData = {
                fullName: document.getElementById('fullName').value,
                studentId: document.getElementById('studentId').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                program: document.getElementById('program').value,
                enrollmentDate: document.getElementById('enrollmentDate').value,
                status: document.getElementById('status').value,
                church: document.getElementById('church').value,
                address: document.getElementById('address').value,
                notes: document.getElementById('notes').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (currentEditingId) {
                    // Update existing student
                    await updateDoc(doc(db, 'students', currentEditingId), studentData);
                    alert('Student updated successfully');
                } else {
                    // Add new student
                    studentData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'students'), studentData);
                    alert('Student added successfully');
                }
                closeModal();
            } catch (error) {
                console.error('Error saving student:', error);
                alert('Error saving student: ' + error.message);
            }
        });

        // Close modals
        window.closeModal = function() {
            document.getElementById('studentModal').classList.add('hidden');
            document.getElementById('studentForm').reset();
            currentEditingId = null;
        };

        window.closeViewModal = function() {
            document.getElementById('viewModal').classList.add('hidden');
        };

        // Export to CSV
        window.exportStudentsToCSV = function() {
            if (filteredStudents.length === 0) {
                alert('No students to export');
                return;
            }

            const csvData = filteredStudents.map(s => ({
                'Student ID': s.studentId,
                'Full Name': s.fullName,
                'Email': s.email,
                'Phone': s.phone || '',
                'Date of Birth': s.dob || '',
                'Gender': s.gender || '',
                'Program': s.program,
                'Enrollment Date': s.enrollmentDate,
                'Status': s.status,
                'Church': s.church || '',
                'Address': s.address || ''
            }));

            const headers = Object.keys(csvData[0]);
            const csvContent = [
                headers.join(','),
                ...csvData.map(row =>
                    headers.map(header =>
                        JSON.stringify(row[header] || '')
                    ).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `students_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };

        // Mobile sidebar toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }

        mobileMenuBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
    </script>
</body>
</html>
